---
- name: Lynis remediation rollback
  hosts: all
  become: true
  vars:
    lynis_backup_dir: /var/backups/lynis_remediation_backup/{{ inventory_hostname }}
    backup_file: /tmp/vulnerabilidades_backup.sql
  tasks:
    - name: Restore configuration backups
      copy:
        src: "{{ item }}"
        dest: "/etc/{{ item | basename | regex_replace('\\.bak$', '') }}"
        remote_src: yes
      loop:
        - "{{ lynis_backup_dir }}/sshd_config.bak"
        - "{{ lynis_backup_dir }}/pwquality.conf.bak"
        - "{{ lynis_backup_dir }}/login.defs.bak"
        - "{{ lynis_backup_dir }}/auditd.conf.bak"
        - "{{ lynis_backup_dir }}/chrony.conf.bak"
      ignore_errors: true

    - name: Reinstall removed packages if recorded
      shell: |
        if [ -f "{{ lynis_backup_dir }}/removed_packages.txt" ]; then
          while read -r pkg; do
            if ! rpm -q "$pkg" &>/dev/null; then
              echo "Reinstalling $pkg..."
              dnf install -y "$pkg" || yum install -y "$pkg" || true
            fi
          done < "{{ lynis_backup_dir }}/removed_packages.txt"
        fi
      args:
        executable: /bin/bash
      when: ansible_facts['pkg_mgr'] != 'apt'

    - name: Re-apply world-writable bits (if file exists)
      shell: |
        if [ -f "{{ lynis_backup_dir }}/world_writable_files.txt" ]; then
          while read -r f; do
            [ -e "$f" ] && chmod o+w "$f" || true
          done < "{{ lynis_backup_dir }}/world_writable_files.txt"
        fi
      args:
        executable: /bin/bash

    - name: Restart critical services
      service:
        name: "{{ item }}"
        state: restarted
      loop:
        - sshd
        - auditd
        - chronyd
      ignore_errors: true

    - name: Report rollback summary
      debug:
        msg: "Rollback complete â€” verify SELinux, firewalld, and SSH manually."
 
    - shell: |
        mysql -u root -pNuevo01 vulnerabilidades < {{ backup_file }}
      when: backup_stat.stat.exists
      args:
        executable: /bin/bash
      changed_when: true