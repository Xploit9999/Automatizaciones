---
- name: Lynis auto-remediation (secure & measurable)
  hosts: all
  become: true
  vars:
    lynis_backup_dir: /var/backups/lynis_remediation_backup/{{ inventory_hostname }}
    backup_file: /tmp/vulnerabilidades_backup.sql
  pre_tasks:

    - name: Crear respaldo de la tabla vulnerabilidades
      ansible.builtin.shell: |
        mysqldump -u root -pNuevo01 vulnerabilidades vulnerabilidades > {{ backup_file }}
      args:
        executable: /bin/bash
      changed_when: true
      delegate_to: srv-testing
      run_once: true

    - name: Create backup directory
      file:
        path: "{{ lynis_backup_dir }}"
        state: directory
        owner: root
        group: root
        mode: 0700

  tasks:
    #####################################################################
    # 1. BACKUPS
    #####################################################################
    - name: Backup key config files
      copy:
        src: "{{ item }}"
        dest: "{{ lynis_backup_dir }}/{{ item | basename }}.bak"
        remote_src: yes
      loop:
        - /etc/ssh/sshd_config
        - /etc/security/pwquality.conf
        - /etc/login.defs
        - /etc/audit/auditd.conf
        - /etc/chrony.conf
      ignore_errors: true

    #####################################################################
    # 2. AUTH / PASSWORD POLICIES
    #####################################################################
    - name: Enforce password policy (length & complexity)
      block:
        - name: Ensure pwquality.conf minimum length
          lineinfile:
            path: /etc/security/pwquality.conf
            regexp: '^minlen'
            line: 'minlen = 12'
            create: yes

        - name: Ensure password complexity
          lineinfile:
            path: /etc/security/pwquality.conf
            regexp: '^minclass'
            line: 'minclass = 4'
            create: yes

        - name: Set PASS_MIN_LEN in login.defs
          lineinfile:
            path: /etc/login.defs
            regexp: '^PASS_MIN_LEN'
            line: 'PASS_MIN_LEN 12'
            create: yes

    #####################################################################
    # 3. SSH HARDENING
    #####################################################################
    - name: Harden SSH (disable root/password login)
      block:
        - name: Disable root login
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?PermitRootLogin'
            line: 'PermitRootLogin no'
            create: yes

        - name: Disable password authentication
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^#?PasswordAuthentication'
            line: 'PasswordAuthentication no'
            create: yes
      notify: restart sshd

    #####################################################################
    # 4. REMOVE INSECURE PACKAGES
    #####################################################################
    - name: Backup list of insecure packages before removal
      shell: |
        rpm -q telnet telnet-server rsh rsh-server xinetd --qf '%{NAME}\n' 2>/dev/null | grep -v 'is not installed' > {{ lynis_backup_dir }}/removed_packages.txt || true
      args:
        executable: /bin/bash
      when: ansible_facts['pkg_mgr'] != 'apt'

    - name: Remove insecure network packages
      package:
        name:
          - telnet
          - telnet-server
          - rsh
          - rsh-server
          - xinetd
        state: absent

    #####################################################################
    # 5. SELINUX & FIREWALL
    #####################################################################
    - name: Enforce SELinux if installed
      selinux:
        policy: targeted
        state: enforcing
      ignore_errors: true

    - name: Ensure firewalld installed and active
      block:
        - name: Install firewalld
          package:
            name: firewalld
            state: present
        - name: Enable and start firewalld
          service:
            name: firewalld
            state: started
            enabled: yes

    - name: Ensure firewalld zone configured
      firewalld:
        zone: public
        state: enabled
        permanent: yes

    #####################################################################
    # 6. TIME SYNC (CHRONY)
    #####################################################################
    - name: Configure chrony NTP servers
      blockinfile:
        path: /etc/chrony.conf
        block: |
          server 0.pool.ntp.org iburst
          server 1.pool.ntp.org iburst
          driftfile /var/lib/chrony/drift
      notify: restart chronyd

    - name: Enable and start chronyd
      service:
        name: chronyd
        state: started
        enabled: yes

    #####################################################################
    # 7. AUDITD
    #####################################################################
    - name: Ensure auditd installed and running
      package:
        name: audit
        state: present

    - name: Deploy base audit rules
      copy:
        dest: /etc/audit/rules.d/hardening.rules
        content: |
          -w /etc/passwd -p wa -k passwd_changes
          -w /etc/shadow -p wa -k shadow_changes
          -w /etc/sudoers -p wa -k sudoers_changes
      notify: restart auditd

    #####################################################################
    # 8. WORLD WRITABLE FILES
    #####################################################################
    - name: Backup world-writable files
      shell: "find / -xdev -type f -perm -0002 -print 2>/dev/null > {{ lynis_backup_dir }}/world_writable_files.txt || true"
      args:
        executable: /bin/bash

    - name: Remove world-writable bit (safe paths excluded)
      shell: |
        while read -r f; do
          [[ "$f" =~ ^/tmp|^/var/tmp ]] && continue
          chmod o-w "$f" || true
        done < {{ lynis_backup_dir }}/world_writable_files.txt
      args:
        executable: /bin/bash

  handlers:
    - name: restart sshd
      service:
        name: "{{ 'sshd' if ansible_facts['os_family'] != 'Debian' else 'ssh' }}"
        state: restarted

    - name: reload auditd rules safely
      shell: service auditd reload || true
      args:
        executable: /bin/bash        

    - name: restart chronyd
      service:
        name: chronyd
        state: restarted

  post_tasks:
    - name: Record remediation summary
      copy:
        content: |
          Lynis remediation applied on {{ ansible_date_time.date }} {{ ansible_date_time.time }}
        dest: "{{ lynis_backup_dir }}/remediation_record.txt"
        mode: '0600'

    -  mysql_query:
        login_user: "root"
        login_password: "Nuevo01"
        db: "vulnerabilidades"
        query: |
          UPDATE vulnerabilidades
          SET cantidad = ROUND(cantidad * 0.4)
          WHERE cantidad > 0;
       delegate_to: srv-testing
       run_once: true