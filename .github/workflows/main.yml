---
name: Test
on:
  push:
    branches: 
      - 'testing'
    paths: 
      - 'contenedores/**'

env:
  REDHAT_REGISTRY: registry.redhat.io
  AUTOMATIONHUB: 23ba-181-133-72-18.ngrok-free.app

jobs:
  tag:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.tag.outputs.version }}

    steps:
      - id: tag
        name: Extrae version del tag del commit
        run: echo version=$(echo ${{ github.event.head_commit.message }} | grep -Eo 'v[0-9]+\.[0-9]+\.[0-9]') >> "$GITHUB_OUTPUT"

      - name: Falla si no hay versi√≥n encontrada
        if: ${{ !startswith(steps.tag.outputs.version, 'v') }}
        run: exit 1

  build:
    runs-on: ubuntu-latest
    needs: tag
    environment: hub
    defaults:
      run:
        shell: bash
        working-directory: contenedores/ee
    env:
      version: ${{ needs.tag.outputs.version }} 

    steps:
      - name: Clona repo
        uses: actions/checkout@v6

      - name: log a redhat
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REDHAT_REGISTRY }}
          username: ${{ vars.REDHAT_USUARIO }}
          password: ${{ secrets.REDHAT_PASS }}

      - name: log al hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.AUTOMATIONHUB }} 
          username: ${{ vars.HUB_USUARIO }}
          password: ${{ secrets.HUB_PASS }}

      - name: build ee
        uses: docker/build-push-action@v6
        with:
          context: "{{defaultContext}}:contenedores/ee/context"
          push: false
          load: true
          tags: ${{ env.AUTOMATIONHUB }}/yagami/ee-testing:${{ env.version }}
          file: Containerfile
          cache-from: type=gha 
          cache-to: type=gha,mode=max

      - name: push ee
        uses: docker/build-push-action@v6
        with:
          context: "{{defaultContext}}:contenedores/ee/context"
          file: Containerfile
          push: true
          tags: ${{ env.AUTOMATIONHUB }}/yagami/ee-testing:${{ env.version }}
          cache-from: type=gha 
          cache-to: type=gha,mode=max

  publish:
    runs-on: ubuntu-latest
    needs: [tag, build]
    environment: hub
    env:
      version: ${{ needs.tag.outputs.version }} 

    steps:

      - name: Consulta ee en AAP
        id: consulta
        uses: fjogeleit/http-request-action@v1
        with:
          url: 'https://${{ env.AUTOMATIONHUB }}/api/controller/v2/execution_environments/SIUU/'
          method: 'GET'
          bearerToken: ${{ secrets.AAP_TOKEN }}
          customHeaders: '{"Content-Type": "application/json"}'

      - name: Actualiza ee en AAP con su ultima version
        if: ${{ steps.consulta.outputs.status == '200' }}
        uses: fjogeleit/http-request-action@v1
        with:
          url: 'https://${{ env.AUTOMATIONHUB }}/api/controller/v2/execution_environments/SIUU/'
          method: 'PATCH'
          bearerToken: ${{ secrets.AAP_TOKEN }}
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"image": "ansibletest.co/yagami/ee-testing:${{ env.version }}"}'

      - name: publica ee en AAP
        if: ${{ steps.consulta.outputs.status == '404' }}
        uses: fjogeleit/http-request-action@v1
        with:
          url: 'https://${{ env.AUTOMATIONHUB }}/api/controller/v2/execution_environments/'
          method: 'POST'
          bearerToken: ${{ secrets.AAP_TOKEN }}
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"name": "SIUU", "image": "ansibletest.co/yagami/ee-testing:${{ env.version }}", "organization": 2}'
...
